FROM ubuntu:22.04

# Create a new user
RUN adduser --disabled-password --gecos '' cpmerp \
    && usermod -aG sudo cpmerp

# Install necessary packages
RUN apt-get update && apt-get upgrade && \
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
    git \
    cron \
    curl \
    wget \
    python3 \
    python3-dev \
    python3-setuptools \
    python3-pip \
    virtualenv \
    software-properties-common \
    mariadb-server \
    libmysqlclient-dev \
    redis-server \
    xvfb \
    libfontconfig \
    python3.10-venv \
    && apt-get clean && rm -rf /var/lib/apt/lists/*
# Install NVM, Node.js, and Yarn

RUN apt-get -y update && apt-get -y upgrade && apt-get -y autoremove

# NodeJS
# Set environment variables
ENV NODE_VERSION 18.18.2
ENV NVM_DIR /home/cpmerp/.nvm
RUN mkdir -p ${NVM_DIR} 
ENV PATH ${NVM_DIR}/versions/node/v${NODE_VERSION}/bin/:${PATH}
RUN wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.5/install.sh | bash \
    && . ${NVM_DIR}/nvm.sh \
    && npm install -g yarn \
    && nvm install ${NODE_VERSION} \
    && nvm use v${NODE_VERSION} \
    && npm install -g yarn \
    && nvm alias default v${NODE_VERSION} \
    && rm -rf ${NVM_DIR}/.cache \
    && echo 'export NVM_DIR="/home/cpmerp/.nvm"' >>~/.bashrc \
    && echo '[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm' >> ~/.bashrc \
    && echo '[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion' >> ~/.bashrc
# Copy MariaDB configuration file and setup script
COPY resources/50-server.cnf /etc/mysql/mariadb.conf.d/50-server.cnf
COPY resources/mysql_setup.sh /usr/local/bin/mysql_setup.sh

# Make the script executable
RUN chmod +x /usr/local/bin/mysql_setup.sh

# Switch user and set permissions
USER cpmerp
WORKDIR /home/cpmerp
# Install Frappe Bench
RUN pip3 install frappe-bench

# Initialize Frappe Bench
ENV PATH="/home/cpmerp/.local/bin:${PATH}"
RUN bench init --frappe-branch version-15 frappe-bench
WORKDIR /home/cpmerp/frappe-bench
RUN bench get-app https://github.com/frappe/erpnext --branch version-15 \
    && bench new-site cpm.com --admin-password=asdf@1234 --root-password=asdf@1234 --install-app erpnext \
    && bench --site cpm.com enable-scheduler \
    && bench --site cpm.com set-maintenance-mode off \
    && bench setup production cpmerp \
    && bench setup nginx \
    && supervisorctl restart all
VOLUME [ \
  "/home/cpmerp/frappe-bench/sites", \
  "/home/cpmerp/frappe-bench/sites/assets", \
  "/home/cpmerp/frappe-bench/logs" \
]
# Expose ports
EXPOSE 80/tcp
EXPOSE 3306

# Start Frappe Bench
CMD ["bench", "serve", "--port", "8000"]
